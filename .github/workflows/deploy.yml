name: CI/CD via GHCR to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ---- Backend build & image push ----
      - name: JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build (Gradle)
        run: ./gradlew clean build -x test

      - name: GHCR login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push image
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/bus-app:${{ github.sha }}"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      # ---- Frontend build (Vite @ root → dist/) ----
      - name: Setup Node (npm cache with lockfile)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: package-lock.json  # 루트 lockfile 기반 캐시

      - name: Ensure lockfile exists
        run: |
          test -f package-lock.json || (echo "❌ package-lock.json not found. Commit it first." && exit 1)

      - name: Install & Build frontend (Vite, npm ci)
        run: |
          npm ci
          npm run build
          echo "---- dist tree ----"
          ls -la dist

      # ---- SSH key as file (safer) ----
      - name: Write SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem

      # 원격 업로드 폴더 보장
      - name: Ensure remote upload dir
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: key.pem
          script: |
            mkdir -p /home/${{ secrets.EC2_USER }}/upload/frontend

      # ---- Upload dist/ to EC2 ----
      - name: Upload frontend (dist/)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: key.pem
          source: dist/**
          target: /home/${{ secrets.EC2_USER }}/upload/frontend
          overwrite: true

      # ---- Activate frontend & deploy backend ----
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key_path: key.pem
          script: |
            set -e
            RELEASE_ID=$(date +%Y%m%d%H%M%S)
            sudo mkdir -p /var/www/bus/releases/${RELEASE_ID}
            sudo cp -r /home/${{ secrets.EC2_USER }}/upload/frontend/* /var/www/bus/releases/${RELEASE_ID}/
            sudo ln -sfn /var/www/bus/releases/${RELEASE_ID} /var/www/bus/current
            ls -1dt /var/www/bus/releases/* | tail -n +6 | xargs -r sudo rm -rf
            sudo nginx -t && sudo systemctl reload nginx
            bash ~/deploy_docker.sh "${IMAGE}"